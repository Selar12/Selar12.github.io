<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REWE E-Bon Analyzer - Enhanced Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Google API Client Library -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .version-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-left: 20px;
            font-weight: 600;
        }

        .setup-section {
            background: #f0f4ff;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }

        .setup-steps {
            margin-top: 20px;
        }

        .setup-step {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .setup-step h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .setup-step code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .auth-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }

        .auth-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .auth-status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .auth-status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        select, input[type="month"], input[type="date"], button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:hover, input[type="month"]:hover, input[type="date"]:hover {
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .sync-button {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-progress {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .table-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f1f3f5;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #666;
        }

        .sync-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: #2e7d32;
        }

        .toggle-view {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .toggle-button {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-button.active {
            background: #667eea;
            color: white;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .category-chip {
            padding: 8px 16px;
            background: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .category-chip.active {
            background: #667eea;
            color: white;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .update-info {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .sync-button {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üõí REWE E-Bon Analyzer
            <span class="version-badge">April 2025 Update</span>
        </h1>

        <div class="update-info">
            <strong>üÜï Neue Features:</strong> Erweiterte Kategorisierung mit 80+ neuen Produkten aus April 2025, 
            verbesserte Parser-Logik f√ºr verschiedene E-Bon Formate, optimierte Produkterkennung.
        </div>
        
        <!-- Setup Instructions -->
        <div class="setup-section" id="setupSection">
            <h2>üìã Einrichtung der Google Drive Integration</h2>
            <p>Um die App mit Ihrem Google Drive zu verbinden, folgen Sie bitte diesen Schritten:</p>
            
            <div class="setup-steps">
                <div class="setup-step">
                    <h3>Schritt 1: Google Cloud Projekt erstellen</h3>
                    <ol>
                        <li>Gehen Sie zu <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                        <li>Erstellen Sie ein neues Projekt oder w√§hlen Sie ein bestehendes</li>
                        <li>Notieren Sie sich die Projekt-ID</li>
                    </ol>
                </div>
                
                <div class="setup-step">
                    <h3>Schritt 2: Google Drive API aktivieren</h3>
                    <ol>
                        <li>Gehen Sie zu "APIs & Services" ‚Üí "Bibliothek"</li>
                        <li>Suchen Sie nach "Google Drive API"</li>
                        <li>Klicken Sie auf "Aktivieren"</li>
                    </ol>
                </div>
                
                <div class="setup-step">
                    <h3>Schritt 3: OAuth 2.0 Client ID erstellen</h3>
                    <ol>
                        <li>Gehen Sie zu "APIs & Services" ‚Üí "Anmeldedaten"</li>
                        <li>Klicken Sie auf "+ ANMELDEDATEN ERSTELLEN" ‚Üí "OAuth-Client-ID"</li>
                        <li>W√§hlen Sie "Webanwendung" als Anwendungstyp</li>
                        <li>F√ºgen Sie bei "Autorisierte JavaScript-Quellen" Ihre Domain hinzu</li>
                        <li>Kopieren Sie die Client-ID</li>
                    </ol>
                </div>
                
                <div class="setup-step">
                    <h3>Schritt 4: Client ID eingeben</h3>
                    <input type="text" id="clientIdInput" placeholder="Ihre Google Client ID hier eingeben..." style="width: 100%; padding: 10px; margin-top: 10px;">
                    <button onclick="saveClientId()" style="margin-top: 10px;">Client ID speichern</button>
                </div>
            </div>
        </div>

        <!-- Auth Section -->
        <div class="auth-section" id="authSection" style="display: none;">
            <button class="auth-button" id="authorizeButton" onclick="handleAuthClick()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                    <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                    <path fill="#FBBC04" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                    <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                </svg>
                Mit Google Drive verbinden
            </button>
            <button class="auth-button" id="signoutButton" onclick="handleSignoutClick()" style="display: none; background: #dc3545;">
                Verbindung trennen
            </button>
            <div class="auth-status disconnected" id="authStatus">Nicht verbunden</div>
        </div>

        <div class="sync-info" id="syncInfo" style="display: none;">
            <p>‚úÖ Mit Google Drive verbunden!</p>
            <p>Letzte Synchronisierung: <span id="lastSync">Noch nicht synchronisiert</span></p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="sync-progress" id="syncProgress">
            <p><strong>Synchronisiere E-Bons...</strong></p>
            <p id="syncStatus">Vorbereitung...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="controls" id="mainControls" style="display: none;">
            <div class="control-group">
                <label for="viewMode">Ansicht:</label>
                <select id="viewMode" onchange="updateView()">
                    <option value="week">Woche</option>
                    <option value="month" selected>Monat</option>
                    <option value="year">Jahr</option>
                    <option value="all">Alle Daten</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="dateFilter">Zeitraum:</label>
                <input type="month" id="dateFilter" onchange="filterData()">
            </div>
            
            <div class="control-group">
                <label for="categoryFilter">Kategorie:</label>
                <select id="categoryFilter" onchange="filterData()">
                    <option value="all">Alle Kategorien</option>
                </select>
            </div>
            
            <button class="sync-button" onclick="syncWithDrive()" id="syncButton">
                üîÑ Mit Google Drive synchronisieren
            </button>
        </div>

        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">0 ‚Ç¨</div>
                <div class="stat-label">Gesamtausgaben</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalReceipts">0</div>
                <div class="stat-label">Anzahl Eink√§ufe</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPerReceipt">0 ‚Ç¨</div>
                <div class="stat-label">Durchschnitt pro Einkauf</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Verschiedene Produkte</div>
            </div>
        </div>

        <div class="toggle-view" id="toggleView" style="display: none;">
            <button class="toggle-button active" onclick="showCharts()">üìä Diagramme</button>
            <button class="toggle-button" onclick="showTables()">üìã Tabellen</button>
        </div>

        <div id="chartsView" style="display: none;">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Ausgaben nach Kategorie</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3 class="chart-title">Ausgaben im Zeitverlauf</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Top 10 h√§ufigste Produkte</h3>
                <canvas id="topProductsChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Preisentwicklung ausgew√§hlter Produkte</h3>
                <div class="category-filter" id="productFilter"></div>
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div id="tablesView" style="display: none;">
            <div class="table-container">
                <h3 class="chart-title">Produkt√ºbersicht</h3>
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th>Kategorie</th>
                            <th>Anzahl gekauft</th>
                            <th>Durchschnittspreis</th>
                            <th>Min. Preis</th>
                            <th>Max. Preis</th>
                            <th>Gesamtausgaben</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>

            <div class="table-container">
                <h3 class="chart-title">Einkaufshistorie</h3>
                <table id="receiptsTable">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Filiale</th>
                            <th>Anzahl Artikel</th>
                            <th>Gesamtbetrag</th>
                        </tr>
                    </thead>
                    <tbody id="receiptsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        const FOLDER_ID = '1y0t0pS3gvlaB4MzrsmRJxuFvwOGEhtfB';

        // Global variables
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let CLIENT_ID = localStorage.getItem('googleClientId') || '';

        // Data storage
        let allReceipts = [];
        let allProducts = [];
        let productCategories = {};
        let charts = {};
        let processedFiles = new Set(JSON.parse(localStorage.getItem('processedFiles') || '[]'));

        // ===== ERWEITERTE KATEGORISIERUNG (April 2025 Update) =====
        const categoryMapping = {
            'Obst & Gem√ºse': [
                // Obst
                'BANANE', 'APFEL', 'KIWI', 'ORANGE', 'MANDARINE', 'HEIDELBEER', 'HIMBEERE',
                'MANGO', 'ERDBEERE', 'KIRSCHEN', 'NEKTARINE', 'PFIRSICH', 'TRAUBE', 'MELONE',
                'ANANAS', 'APRIKOSE', 'BIRNE', 'PFLAUME', 'WEINTRAUBE', 'BLAUBEERE', 'ZITRONE',
                'WASSERMELONE', 'CANTALOUPE', 'HONIGMELONE', 'GRAPEFRUIT', 'LIMETTE', 'BEEREN',
                'ZWETSCHGE', 'TROPISCHE MISCH', 'TROPISCHE FRUCHT', 'GARTEN ERDBEEREN',
                'EXTRA ERDBEERE', 'EXTRA HIMBEERE', 'EXTRA HEIDELBEER', 'EXTRA 3 BEEREN',
                // April Erg√§nzungen
                'BANANE CHIQUITA', 'APFEL BRAEBURN', 'MELONE HONIG', 'ORANGE 1KG SL',
                'TRAUBE KERNL.HEL', 'OBST/GEMUESE',
                
                // Gem√ºse
                'TOMATE', 'CHERRYROMATOMATE', 'SALATGURKE', 'GURKE', 'PAPRIKA', 'KARTOFFEL',
                'KAROTTE', 'ZWIEBEL', 'AVOCADO', 'INGWER', 'KNOBLAUCH', 'PORREE', 'LAUCH',
                'CHAMPIGNON', 'AUBERGINE', 'ZUCCHINI', 'BROKKOLI', 'BROCCOLI', 'KOHLRABI',
                'KUERBIS', 'KOPFSALAT', 'FELDSALAT', 'EISBERGSALAT', 'SALAT', 'SPINAT',
                'RUCOLA', 'RADIESCHEN', 'LAUCHZWIEBEL', 'BABYSPINAT', 'SALAT BUNT',
                'MINIRISPE', 'SALAT KOPF', 'KAROTT', 'KARTOF', 'FR.KAROTT',
                // April Erg√§nzungen
                'INGWER BIO', 'KAROTTE REGIONAL', 'PAPRIKA ROT', 'SALAT BUNT GRUEN',
                'SONNENBLUMMENK.',
                
                // Konserven/Verarbeitetes Gem√ºse
                'STUECKIGE TOMATE', 'PASSIERTE TOMATE', 'SCHAELTOMATEN', 'TOMATENMARK',
                'POLPA FINE', 'GEH. TOMATEN', 'TOMATEN PASSIERT', 'TOMATEN STUECKIG',
                'SAUERKIRSCHEN', 'APFELMUS', 'APFELMARK', 'GURKENHAPPEN', 'SAUERKRAUT',
                'CORNICHONS', 'SCHLES.GURKENHAP', 'SCH.GURKENHAPPEN',
                // April Erg√§nzungen
                'BIO GEH. TOMATEN', 'TOMATENM.BASILI.'
            ],
            
            'Fleisch & Wurst': [
                'FLEISCHWURST', 'WIENER', 'HACKFLEISCH', 'PUTENBRUST', 'BRATWURST',
                'HAEHNCHEN', 'HAEHNCHENSCH', 'SCHINKEN', 'SALAMI', 'METTWURST', 'BOCKWURST',
                'BACON', 'MINUTENSTEAK', 'RIND', 'SCHWEIN', 'GEFL√úGEL', 'CHICKEN',
                'STEAK', 'GULASCH', 'LEBERWURST', 'LYONER', 'ROSTBRATWURST', 'SCHINKENWURST',
                'TEEWURST', 'CERVELATWURST', 'MORTADELLA', 'ENTRECOTE', 'FILET',
                'KOTELETT', 'LAMMFLEISCH', 'WILDFLEISCH', 'KASSELER', 'SPECK',
                'KRAKAUER', 'FRIKADELLE', 'ROSTBRATW', 'RUECKENSTEAK', 'GRILLIES',
                'CHICKEN NUGGETS', 'CHICKEN DRUMS', 'CHICKEN WINGS', 'HA-HAEHN',
                // April Erg√§nzungen
                'WIENER WUERSTCHE', 'SCHINKENFL. KNOB', 'GEFL.LYONER', 'GEFLUEGEL SALAMI',
                'RD GULASCH KEULE', 'HAEHNCHEN SALAMI', 'HAEHN. SCHENKEL'
            ],
            
            'Milchprodukte': [
                // Milch & Sahne
                'BERGBAUERNMI', 'MILCH', 'WEIDEMILCH', 'SAHNE', 'SCHLAGSAHNE', 'CREME FRAICHE',
                'SCHMAND', 'SAHNSTEIFE', 'SAHNESTEIFE',
                // April Erg√§nzungen
                'BERGBAUERNMI 3,5', 'BERGBAUERNM.1,5%', 'BIO WEIDEMILCH', 'CR.FRAICHE NATUR',
                'SCHLAGSAHNE 33%',
                
                // Joghurt & Quark
                'JOGHURT', 'KINDERJOG', 'KINDERJOGHURT', 'FRUCHTJOGHURT', 'FRUCHTQUARK',
                'QUARK', 'DICKMILCH', 'KEFIR', 'KALINKA KEFIR', 'BUTTERMILCH',
                'JOGURT', 'NATURJOGHURT', 'FRUCHTJO', 'GOETTERSP', 'MUELLERMILCH',
                'MONTE', 'ZOTT MONTE', 'SAHNEPUDDING', 'PUDDING',
                // April Erg√§nzungen
                'KINDERJO.PFIR.BA', 'KINDERJOG.HIMBEE', 'KINDERJOG.ERDBEE', 'JOGH.NATURMILD',
                'FRUCHTJO.APRT', 'FRUCHTJOGH.HIMB.', 'FRUCHTJOGH.HEID.', 'BIO JOGH ERD/HIM',
                'BIO JOGH HEIDELB', 'BIO JOGH PFIR.PA', 'NATUR', 'KALINKA',
                
                // K√§se
                'KAESE', 'GOUDA', 'EMMENTALER', 'MOZZARELLA', 'FETA', 'CAMEMBERT',
                'FRISCHKAESE', 'PHILADELPHIA', 'ALMETTE', 'GERAMONT', 'BEEMSTER',
                'CAMPINA', 'WESTLITE', 'GRAEDDOST', 'PARMESAN', 'RICOTTA', 'MASCARPONE',
                'BRESSO', 'EXQUISA', 'BUKO', 'MIREE', 'SALAKIS', 'PATROS', 'REIBEKAESE',
                'GERIEBEN',
                // April Erg√§nzungen
                'GOUDA GERIEBEN', 'CAMPINA GOUDA JG', 'GRAEDDOST SCHNIT',
                
                // Butter & Streichfette
                'BUTTER', 'MARKENBUTTER', 'WEIDEBUTTER', 'STREICHFETT', 'IRISCHE BUTTER',
                'RAMA', 'DELI REFORM',
                // April Erg√§nzungen
                'MARKENBUTTER ALU'
            ],
            
            'Backwaren': [
                'BROT', 'BROETCHEN', 'TOAST', 'BAGUETTE', 'LAUGENB', 'SONNTAGSBROETCH',
                'DINKEL-BROETCHEN', 'DINKELMEHL', 'MEHL', 'WEIZENMEHL', 'ROGGENMEHL',
                'VOLLKORNBROT', 'PUMPERNICKEL', 'CIABATTA', 'CROISSANT', 'HEFE',
                'BACKPULVER', 'VANILLEZUCKER', 'VANILLINZUCKER', 'BACKIN', 'KNAECKE',
                'ZWIEBACK', 'KNUSPERBROT', 'DINKEL SANDWICH', 'DINKEL 630',
                'KOERNER BALANCE', 'ROGGEN BROETCH',
                // April Erg√§nzungen
                'HEFE AUFSTELLER', 'BAGUETTE HAWAII', 'BAGUETTE BOLOGN.'
            ],
            
            'Getr√§nke': [
                // Wasser & S√§fte
                'COCA COLA', 'COLA', 'SCHLOSSQU', 'VITAMIN SAFT', 'APFELSAFT', 'ORANGENSAFT',
                'SAFT', 'WASSER', 'LEMONAID', 'MINERALWASSER', 'SPRUDEL', 'HEILWASSER',
                'TRAUBENSAFT', 'KIRSCHSAFT', 'ANANASSAFT', 'MULTI', 'ROTER MULTI',
                'APFELSINENSAFT', 'ORANGE SAFT', 'HOHES C',
                // April Erg√§nzungen
                'SCHLOSSQU. NATUR', 'HEILWASSER STILL', 'MULTIVITAM.SAFT', 'LANDPARK BIO NAT',
                
                // Kaffee & Tee
                'KAFFEE', 'CAFFEE', 'CAFFE CREMA', 'DALLMAYR', 'EDUSCHO', 'PRODOMO',
                'NESCAFE', 'QUALITA ROSSA', 'TEE', 'MATCHA', 'KAMILLE', 'KAMILLEN TEE',
                'SALBEI', 'YOGI', 'KRAEUTER ORIG',
                // April Erg√§nzungen
                'BARISTA DJ', 'KAMILLE 20ER',
                
                // Kakao & Milchgetr√§nke
                'KAKAO', 'CHOCOMEL', 'NESQUIK', 'KAKAOGETRAENK',
                
                // Bier & Alkoholfreies
                'BIER', 'VELTINS', 'FIEGE', 'LANDPARK', 'KROM', 'GREVENSTEINER',
                'FASSBRAU', 'ENERGY', 'EISTEE', 'SMOOTHIE', 'LIMONADE'
            ],
            
            'S√º√üwaren & Snacks': [
                // Schokolade
                'SCHOKOLADE', 'SCHOKO', 'DUPLO', 'KITKAT', 'LION', 'KINDER',
                'TOFFIFEE', 'SCHOKOBONS', 'ALPENMILCH', 'VOLLMILCH', 'HASELNUSS',
                'NUSS-NOUGAT', 'BION.NUSS-NOUGAT', 'KNUSPER NUSS', 'VOLL-NUSS',
                'EDEL-VOLLMILCH', 'RASPELSCHOKOLADE', 'GLASUR KAKAO', 'MARS', 'TWIX',
                'CELEBRATIONS', 'RIEGEL', 'HANUTA', 'MONTE SCHOKO', 'CHOCOLAT',
                // April Erg√§nzungen
                'KIND. SCHOKOBONS', 'TOFFIFEE 15ER',
                
                // Gummib√§rchen & Bonbons
                'HARIBO', 'GUMMIBAERCHEN', 'LAKRITZ', 'BONBON', 'LUTSCHER',
                'MARSHMALLOW', 'PASTA FRU', 'STARMIX', 'RAINBOW', 'HAPPY COL',
                'TROPI FRU', 'GOLDBAER', 'YOGHURT GUMS', 'EUKAL', 'LOLLIES',
                // April Erg√§nzungen
                'PASTA FRUTTA',
                
                // Kekse & Geb√§ck
                'PRINZENROLLE', 'KEKS', 'WAFFEL', 'BROWNIE', 'FRISCHEIWAFFEL',
                'MINI MAGDALENAS', 'ERDBEERSTREIFEN',
                
                // Chips & Salziges
                'CHIPS', 'CRUNCHIPS', 'PRINGLES', 'SALTLETTS', 'SALZSTANGEN',
                'POPCORN', 'OFEN CHIPS', 'KESSELCHIPS', 'CHIPSFR', 'RIFFELS',
                'LAYS', 'SNACK HITS', 'TUC', 'ERDNUESSE', 'OFEN ERDNUESSE', 'NUSS',
                // April Erg√§nzungen
                'RIFFELS NATURELL'
            ],
            
            'Grundnahrungsmittel': [
                // Nudeln & Reis
                'NUDELN', 'REIS', 'FUSILLI', 'SPAGHETTI', 'PENNE', 'SPIRALEN',
                'LASAGNE', 'BASMATI', 'PASTA', 'FARFALLE', 'ELICHE', 'KORKENZIEHERNUD',
                'MACCHERONI', 'SPAETZLE', 'COLLEZ.FARFALLE', 'DINKEL SPAGH',
                'BUCHSTABEN', 'KLEBEREIS', 'HIMALAYA BASMATI', 'HIMALYA BASMATI',
                // April Erg√§nzungen
                'GEN.PUR SPAETZLE', 'LASAGNE GELB',
                
                // Eier
                'EIER', '10ER', '6ER',
                // April Erg√§nzungen
                'EIER 10ER FL OKT', 'EIER FH RES 10ER', '6ER BUNTE EIER',
                
                // Getreide & H√ºlsenfr√ºchte
                'LINSEN', 'BULGUR', 'COUSCOUS', 'QUINOA', 'HAFERFLOCKEN', 'MUESLI',
                'ROTE LINSEN', 'KICHERERBSEN', 'BOHNEN', 'ERBSEN', 'URKORN MUESLI',
                'FLOHSAMEN', 'CHIA SAMEN', 'LEINSAMEN',
                
                // √ñl & Essig
                'OEL', 'OLIVENOEL', 'SONNENBLUMENOEL', 'RAPSOEL', 'ESSIG', 'REISESSIG',
                'KOKOSFETT', 'KOKOSM.FETTRED',
                // April Erg√§nzungen
                'PALM.DG OLIVE',
                
                // Zucker & Salz
                'ZUCKER', 'SALZ', 'JODSALZ', 'ALPENJODSALZ', 'WUERFELZUCKER', 'PUDERZUCKER',
                'FEINSTER ZUCKER',
                
                // Honig & Aufstriche
                'HONIG', 'MARMELADE', 'NUTELLA', 'KONFITUE', 'KONF.', 'BROTAUFSTRICH',
                'IMKER HONIG', 'BLUETENHONIG', 'GEBIRGSBL.HONIG', 'SALBEI-HONIG',
                // April Erg√§nzungen
                'ERDBEER KONFITUE', 'DIB BLUETENHONIG'
            ],
            
            'Gew√ºrze & Saucen': [
                // Gew√ºrze
                'GEWUERZE', 'PFEFFER', 'CURRY', 'PAPRIKA', 'CHILI', 'BASILIKUM',
                'ROSMARIN', 'KRAEUTER', 'ZWIEBEL-KRAEUTER', 'GARTENKR', 'CURRY PULVER',
                'CHILIPULVER', 'PFEFFER SCHWARZ', 'SWEET PAPRIKA', 'SESAM',
                // April Erg√§nzungen
                'KRAEUTER ORIG.',
                
                // Saucen & Dressings
                'KETCHUP', 'MAYONNAISE', 'SENF', 'BBQ SAUCE', 'REMOULADE', 'MIRACEL WHIP',
                'SALAT MAYONNAISE', 'KNOBLAUCHSAUCE', 'SCHASCHLIKSAUCE', 'COCKTAILSAUCE',
                'TOMATENKETCHUP', 'TOMATO KETCHUP', 'KNOBL. SAUCE', 'SAUCE ZU BRATEN',
                // April Erg√§nzungen
                'SCHLEFI BORDELAI', 'SCHLEFI TOMATE',
                
                // Br√ºhen & W√ºrzmittel
                'BOUILLON', 'BRUEHE', 'MAGGI', 'DELI. BRUEHE', 'GEMUESE BOUILLON',
                'HUEHNERSUPPE', 'CLASSIC WUERFEL', 'SK BLOCK KRAEUT',
                // April Erg√§nzungen
                'BOUIL.RIND'
            ],
            
            'Fertiggerichte & Konserven': [
                'PIZZA', 'FISCHSTAEBCHEN', 'CHICKEN NUGGETS', 'SCHUPFNUDELN',
                'RAVIOLI', 'GOLDMAIS', 'ERBSEN', 'MAIS', 'ZUCKERMAIS', 'ERBSEN MOEHRCHEN',
                'ERBSEN M.KAROTT', 'TOMATEN DOSE', 'SCHAELTOMATEN', 'PASSIERTE TOMATE',
                'STUECKIGE TOMATE', 'SAUERKRAUT', 'GURKEN', 'BOHNEN', 'LINSEN DOSE',
                'KICHERERBSEN', 'CHAMPIGNONS DOSE', 'THUNFISCH', 'SARDINEN', 'HERINGSFILET',
                'ANANAS DOSE', 'ANANASSCHEIBEN', 'ANANAS CHUNKS', 'NUDELN IN TOMAT',
                'MIN HUHN NU', 'GEMUESE RAVIOLI', 'GNOCCHI', 'REIBEKUCHENTEIG',
                // April Erg√§nzungen
                '10 FISCHSTAEBCH.', '1-2-3 STEAK FRIT'
            ],
            
            'Fisch & Meeresfr√ºchte': [
                'LACHS', 'FORELLE', 'THUNFISCH', 'GARNELE', 'KRABBEN', 'MUSCHELN',
                'TINTENFISCH', 'KABELJAU', 'SEELACHS', 'HERING', 'MAKRELE', 'SARDINE',
                'FISCHFILET', 'RAEUCHERLACHS', 'MATJES', 'ROLLMOPS', 'BISMARCKHERING',
                'LIEBLINGS LACHS', 'MEIN LIEB. LACHS', 'RAEUCHER-LACHS', 'RAEUCHERL',
                'BIO RAEUCHERLACH', 'AUSLESE CLASSIC'
            ],
            
            'Haushalt & Hygiene': [
                // Hygieneartikel
                'ALWAYS', 'SENSODYNE', 'ZAHNPASTA', 'SHAMPOO', 'DUSCHE', 'SEIFE',
                'DEO', 'RASIERER', 'GILLETTE', 'PFLEGEDUSCHE', 'MUNDWASSER', 'MUNDSPUELUNG',
                'ZAHNSEIDE', 'HANDCREME', 'BODYLOTION', 'GESICHTSCREME', 'WATTESTAEBCHEN',
                'FEUCHTTUCH', 'MEN EXPERT', 'KNEIPP', 'SCHAUMBAD', 'TRAUMBAD',
                'KINDERZAHNP', 'KINDERZAHNB', 'KINDER SHAMPOO', 'L OREAL',
                // April Erg√§nzungen
                'FRISCH & SENSIT.', 'ALWAYS SLIPEINL', 'ZITRONE HANDSPUE',
                
                // Babyartikel
                'PENATEN', 'PAMPERS', 'WINDELN', 'BUEB.BABY', 'BP PANTS', 'SP PANTS',
                'FEUCHTTUCH SENS',
                // April Erg√§nzungen
                'SP NB GR.1 NEWB.', 'SP GR. 8 XL 17+',
                
                // Putzmittel
                'TOILETTENPAP', 'KUECHENTUECHER', 'MUELLBTL', 'REINIGER', 'SPUELMITTEL',
                'WASCHMITTEL', 'SCHWAMM', 'PRIL', 'HYGIENE REINIGER', 'WC REIN',
                'SAGROTAN', 'MR.PROPER', 'DOM. WCS', 'TOPFREINIGER', 'ENTKALKER',
                'REINIGER PASTE', 'MASCHINENT. REIN', 'FENSTERTUCH', 'JEANS-BL TUECHER',
                'LUXUS TOILET.PAP', 'ZEWA'
            ],
            
            'Tiefk√ºhl': [
                'TK-', 'TIEFKUEHL', 'EISBERGSALAT TK', 'SPINAT TK', 'ERBSEN TK',
                'POMMES', 'KROKETTEN', 'FISCHFILET TK', 'GARNELEN TK', 'BEEREN TK',
                'GEMUESE TK', 'KRAEUTERMIX TK', 'FERTIGGERICHT TK', 'EIS', 'SPEISEEIS',
                'TK BEERENMISCH', 'FREIBAD POMMMES', 'SUESSK. POMMES',
                // April Erg√§nzungen
                'STRACCIATELLA' // Eis
            ],
            
            'Babynahrung': [
                'KAROT.KART.RIND', 'FR.KAROTT+KARTOF', 'BABYGLAS', 'HIPP', 'ALETE',
                'BEBIVITA', 'BABYBREI', 'FOLGEMILCH', 'ANFANGSMILCH', 'BABYKEKS',
                'BAN.APF.ERD.H', 'BAN.,ERDB.,QUIN.', 'RG BIRNE PFL.BR.'
            ],
            
            'Pfand': [
                'PFAND', 'LEERG', 'EINWEG', 'MEHRWEG',
                // April Erg√§nzungen
                'PFAND 0,25 EURO', 'PFAND 3,30 EUR', 'PFAND 0,15 EUR', 'LEERG. MW V. ST'
            ],
            
            'Sonstiges': []
        };

        // ===== ERWEITERTE KATEGORISIERUNGSFUNKTION =====
        function categorizeProduct(productName) {
            const upperName = productName.toUpperCase();
            
            // Durchsuche alle Kategorien
            for (const [category, keywords] of Object.entries(categoryMapping)) {
                if (category === 'Sonstiges') continue;
                
                for (const keyword of keywords) {
                    if (upperName.includes(keyword)) {
                        return category;
                    }
                }
            }
            
            // Erweiterte Fallback-Logik
            if (upperName.includes('DINKELMEHL') || upperName.includes('D DINKEL')) {
                return 'Backwaren';
            }
            if (upperName.includes('BERGBAUERN')) {
                return 'Milchprodukte';
            }
            if (upperName.includes('ORANGE SAFT') || upperName.includes('APFELSAFT')) {
                return 'Getr√§nke';
            }
            if (upperName.match(/\d+ER\s+(BUNTE\s+)?EIER/)) {
                return 'Grundnahrungsmittel';
            }
            if (upperName.includes('EURO') && upperName.includes('PFAND')) {
                return 'Pfand';
            }
            if (upperName.includes('JOGHURT') || upperName.includes('JOGH')) {
                return 'Milchprodukte';
            }
            if (upperName.includes('WURST') || upperName.includes('SCHINKEN')) {
                return 'Fleisch & Wurst';
            }
            if (upperName.includes('CHIPS')) {
                return 'S√º√üwaren & Snacks';
            }
            
            return 'Sonstiges';
        }

        // ===== VERBESSERTER PARSER =====
        function parseEBon(content, fileName) {
            console.log(`\n=== Parsing ${fileName} ===`);
            
            // Extract date from filename
            const dateMatch = fileName.match(/(\d{2})\.(\d{2})\.(\d{4})/);
            if (!dateMatch) {
                console.log('No date found in filename');
                return null;
            }
            
            const date = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`;
            console.log('Date:', date);
            
            // Clean up content
            content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            content = content.replace(/^\ufeff/, '');
            
            console.log('Content length:', content.length);
            
            // Handle single-line format
            if (content.split('\n').length < 5) {
                console.log('Detected single-line format, reformatting...');
                
                content = content.replace(/\s+(EUR)\s+/g, '\n$1\n');
                content = content.replace(/\s+(--+)/g, '\n$1\n');
                content = content.replace(/\s+(==+)/g, '\n$1\n');
                content = content.replace(/\s+(\*\s*\*)/g, '\n$1');
                content = content.replace(/\s+(SUMME)/g, '\n$1');
                content = content.replace(/\s+([A-Z][A-Z\s\.\-]+?)\s+(\d+[,\.]\d{2}\s*[AB]?)/g, '\n$1 $2');
            }
            
            const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            console.log(`Total lines: ${lines.length}`);
            
            const items = [];
            let total = 0;
            let store = 'REWE';
            let inProductSection = false;
            
            // Detect store
            if (content.includes('Ennepetal')) {
                store = 'REWE Ennepetal';
            } else if (content.includes('Breckerfeld')) {
                store = 'REWE Breckerfeld';
            } else if (content.includes('Hagen')) {
                store = 'REWE Hagen';
            }
            
            // Process lines
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line === 'EUR' && !inProductSection) {
                    console.log(`Product section starts at line ${i}`);
                    inProductSection = true;
                    continue;
                }
                
                if (inProductSection && 
                    (line.includes('----') || 
                     line.includes('====') || 
                     line.includes('SUMME') ||
                     line.includes('* *') ||
                     line.includes('Kundenbeleg'))) {
                    console.log(`Product section ends at line ${i}`);
                    
                    if (line.includes('SUMME')) {
                        const totalMatch = line.match(/SUMME\s+(?:EUR\s+)?(\d+[,\.]\d{2})/);
                        if (totalMatch) {
                            total = parseFloat(totalMatch[1].replace(',', '.'));
                            console.log(`Found total: ${total}`);
                        }
                    }
                    break;
                }
                
                if (!inProductSection) continue;
                
                // Skip non-product lines
                if (line === 'EUR' ||
                    line.includes('Handeingabe') || 
                    line.includes('E-Bon') ||
                    line.includes('Tel.:') ||
                    line.includes('UID') ||
                    line.includes('=') ||
                    line.includes('%') ||
                    line.includes('Steuer') ||
                    line.includes('Netto') ||
                    line.includes('Brutto') ||
                    line.length < 3) {
                    continue;
                }
                
                // Match product pattern
                const productMatch = line.match(/^(.+?)\s+(\d+[,\.]\d{2})(?:\s+([AB]))?$/);
                
                if (productMatch) {
                    const productName = productMatch[1].trim();
                    const price = parseFloat(productMatch[2].replace(',', '.'));
                    const taxCategory = productMatch[3] || 'B';
                    
                    console.log(`  Found: "${productName}" - ${price}‚Ç¨ [${taxCategory}]`);
                    
                    // Validate product
                    if (price > 0 && price < 1000 && productName.length > 1 &&
                        !productName.match(/^\d/) &&
                        !productName.includes('=') &&
                        !productName.includes('EUR') &&
                        !productName.includes('AUSZAHLUNG') &&
                        !productName.includes('Geg.')) {
                        
                        const item = {
                            name: productName.toUpperCase(),
                            price: price,
                            quantity: 1,
                            unitPrice: price,
                            category: categorizeProduct(productName)
                        };
                        
                        items.push(item);
                        console.log(`  Added to category: ${item.category}`);
                    }
                }
            }
            
            console.log(`Found ${items.length} items`);
            
            // Alternative parsing for single-line format
            if (items.length === 0 && lines.length > 0) {
                console.log('Trying alternative parsing...');
                const firstLine = lines[0];
                
                const eurIndex = firstLine.indexOf(' EUR ');
                if (eurIndex > 0) {
                    const productsPart = firstLine.substring(eurIndex + 5);
                    const productRegex = /([A-Z][A-Z\s\.\-]+?)\s+(\d+[,\.]\d{2})\s*([AB])?/g;
                    let match;
                    
                    while ((match = productRegex.exec(productsPart)) !== null) {
                        const productName = match[1].trim();
                        const price = parseFloat(match[2].replace(',', '.'));
                        
                        if (productName.includes('----') || productName.includes('SUMME')) {
                            break;
                        }
                        
                        if (price > 0 && price < 1000 && productName.length > 1) {
                            const item = {
                                name: productName.toUpperCase(),
                                price: price,
                                quantity: 1,
                                unitPrice: price,
                                category: categorizeProduct(productName)
                            };
                            
                            items.push(item);
                            console.log(`Alternative parse: ${productName} - ${price}‚Ç¨`);
                        }
                    }
                }
            }
            
            // Find total if not found
            if (!total && items.length > 0) {
                const totalMatch = content.match(/(?:SUMME|Gesamtbetrag)[^\d]*(\d+[,\.]\d{2})/);
                if (totalMatch) {
                    total = parseFloat(totalMatch[1].replace(',', '.'));
                } else {
                    total = items.reduce((sum, item) => sum + item.price, 0);
                }
            }
            
            if (items.length === 0) {
                console.log('No items found');
                return null;
            }
            
            return {
                date: date,
                store: store,
                total: total,
                items: items
            };
        }

        // ===== INITIALIZATION =====
        window.onload = function() {
            if (CLIENT_ID) {
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                // Load Google API
                gapi.load('client', initializeGapiClient);
                
                // Load Identity Services
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.onload = initializeGisClient;
                document.body.appendChild(script);
            } else {
                document.getElementById('setupSection').style.display = 'block';
                document.getElementById('authSection').style.display = 'none';
            }
            
            // Set current month as default
            const now = new Date();
            document.getElementById('dateFilter').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // Load stored data
            loadStoredData();
        };

        function saveClientId() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (clientId) {
                CLIENT_ID = clientId;
                localStorage.setItem('googleClientId', clientId);
                location.reload();
            } else {
                showError('Bitte geben Sie eine g√ºltige Client ID ein.');
            }
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function initializeGisClient() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        throw (response);
                    }
                    updateAuthStatus(true);
                    if (processedFiles.size === 0) {
                        syncWithDrive();
                    }
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorizeButton').disabled = false;
                
                if (gapi.client.getToken() !== null) {
                    updateAuthStatus(true);
                }
            }
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                updateAuthStatus(true);
                await syncWithDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateAuthStatus(false);
            }
        }

        function updateAuthStatus(isSignedIn) {
            const authStatus = document.getElementById('authStatus');
            const authorizeButton = document.getElementById('authorizeButton');
            const signoutButton = document.getElementById('signoutButton');
            const syncInfo = document.getElementById('syncInfo');
            const mainControls = document.getElementById('mainControls');
            const statsGrid = document.getElementById('statsGrid');
            const toggleView = document.getElementById('toggleView');
            const chartsView = document.getElementById('chartsView');
            
            if (isSignedIn) {
                authStatus.textContent = 'Verbunden mit Google Drive';
                authStatus.className = 'auth-status connected';
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'inline-flex';
                syncInfo.style.display = 'block';
                mainControls.style.display = 'flex';
                statsGrid.style.display = 'grid';
                toggleView.style.display = 'flex';
                chartsView.style.display = 'block';
            } else {
                authStatus.textContent = 'Nicht verbunden';
                authStatus.className = 'auth-status disconnected';
                authorizeButton.style.display = 'inline-flex';
                signoutButton.style.display = 'none';
                syncInfo.style.display = 'none';
            }
        }

        async function syncWithDrive() {
            if (!gapi.client.getToken()) {
                showError('Bitte verbinden Sie sich zuerst mit Google Drive.');
                return;
            }

            const syncButton = document.getElementById('syncButton');
            const syncProgress = document.getElementById('syncProgress');
            const syncStatus = document.getElementById('syncStatus');
            const progressFill = document.getElementById('progressFill');
            
            syncButton.disabled = true;
            syncProgress.style.display = 'block';
            
            try {
                console.log('=== Starting sync ===');
                
                syncStatus.textContent = 'Lade Dateiliste...';
                progressFill.style.width = '10%';
                
                const files = await listAllFiles();
                console.log(`Found ${files.length} files in Google Drive`);
                
                const newFiles = files.filter(file => !processedFiles.has(file.id));
                console.log(`${newFiles.length} new files to process`);
                
                if (newFiles.length === 0) {
                    syncStatus.textContent = 'Keine neuen E-Bons gefunden.';
                    progressFill.style.width = '100%';
                    
                    if (allReceipts.length > 0) {
                        updateView();
                    } else {
                        showError('Keine E-Bons gefunden. Stellen Sie sicher, dass die Dateien im richtigen Ordner sind.');
                    }
                    
                    setTimeout(() => {
                        syncProgress.style.display = 'none';
                    }, 2000);
                    return;
                }
                
                syncStatus.textContent = `${newFiles.length} neue E-Bons gefunden. Verarbeite...`;
                
                let processed = 0;
                let successCount = 0;
                
                for (const file of newFiles) {
                    try {
                        console.log(`\nProcessing file: ${file.name}`);
                        const receipt = await processEBon(file);
                        
                        if (receipt) {
                            allReceipts.push(receipt);
                            processedFiles.add(file.id);
                            successCount++;
                            console.log(`‚úì Successfully processed: ${file.name}`);
                        } else {
                            console.log(`‚úó Failed to parse: ${file.name}`);
                        }
                        
                        processed++;
                        const progress = 10 + (processed / newFiles.length) * 80;
                        progressFill.style.width = `${progress}%`;
                        syncStatus.textContent = `Verarbeite E-Bon ${processed} von ${newFiles.length}...`;
                    } catch (error) {
                        console.error(`Error processing ${file.name}:`, error);
                    }
                }
                
                console.log(`\nProcessing complete: ${successCount} of ${newFiles.length} files parsed successfully`);
                
                syncStatus.textContent = 'Analysiere Produkte...';
                progressFill.style.width = '95%';
                
                processProducts();
                saveData();
                
                syncStatus.textContent = `Synchronisierung abgeschlossen! ${successCount} E-Bons verarbeitet.`;
                progressFill.style.width = '100%';
                
                document.getElementById('lastSync').textContent = new Date().toLocaleString('de-DE');
                
                updateView();
                
                setTimeout(() => {
                    syncProgress.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                showError('Fehler beim Synchronisieren: ' + error.message);
                console.error('Sync error:', error);
            } finally {
                syncButton.disabled = false;
            }
        }

        async function listAllFiles() {
            console.log('Listing files from folder:', FOLDER_ID);
            const files = [];
            let pageToken = null;
            
            try {
                do {
                    const response = await gapi.client.drive.files.list({
                        q: `'${FOLDER_ID}' in parents and mimeType='application/vnd.google-apps.document'`,
                        fields: 'nextPageToken, files(id, name, modifiedTime)',
                        pageSize: 100,
                        pageToken: pageToken
                    });
                    
                    if (response.result && response.result.files) {
                        files.push(...response.result.files);
                        console.log(`Found ${response.result.files.length} files in this batch`);
                    }
                    
                    pageToken = response.result.nextPageToken;
                } while (pageToken);
                
                console.log('Total files found:', files.length);
                
            } catch (error) {
                console.error('Error listing files:', error);
                throw error;
            }
            
            return files;
        }

        async function processEBon(file) {
            try {
                const response = await gapi.client.drive.files.export({
                    fileId: file.id,
                    mimeType: 'text/plain'
                });
                
                const content = response.body;
                const receipt = parseEBon(content, file.name);
                
                return receipt;
            } catch (error) {
                console.error('Error processing e-bon:', error);
                return null;
            }
        }

        function processProducts() {
            allProducts = [];
            const productMap = {};

            allReceipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    if (!productMap[item.name]) {
                        productMap[item.name] = {
                            name: item.name,
                            category: item.category || categorizeProduct(item.name),
                            purchases: [],
                            totalQuantity: 0,
                            totalSpent: 0
                        };
                    }
                    
                    productMap[item.name].purchases.push({
                        date: receipt.date,
                        price: item.price,
                        quantity: item.quantity || 1,
                        unitPrice: (item.quantity || 1) > 0 ? item.price / (item.quantity || 1) : item.price
                    });
                    
                    productMap[item.name].totalQuantity += (item.quantity || 1);
                    productMap[item.name].totalSpent += item.price;
                });
            });

            allProducts = Object.values(productMap);
            
            allProducts.forEach(product => {
                productCategories[product.name] = product.category;
            });
            
            updateCategoryFilter();
        }

        function loadStoredData() {
            const storedData = localStorage.getItem('reweEbonData');
            if (storedData) {
                const data = JSON.parse(storedData);
                allReceipts = data.receipts || [];
                allProducts = data.products || [];
                productCategories = data.categories || {};
                
                if (data.lastSync) {
                    document.getElementById('lastSync').textContent = new Date(data.lastSync).toLocaleString('de-DE');
                }
                
                if (allReceipts.length > 0) {
                    updateView();
                }
            }
        }

        function saveData() {
            const data = {
                receipts: allReceipts,
                products: allProducts,
                categories: productCategories,
                lastSync: Date.now()
            };
            localStorage.setItem('reweEbonData', JSON.stringify(data));
            localStorage.setItem('processedFiles', JSON.stringify(Array.from(processedFiles)));
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ===== VIEW UPDATE FUNCTIONS =====
        function updateCategoryFilter() {
            const categories = [...new Set(Object.values(productCategories))];
            const select = document.getElementById('categoryFilter');
            
            select.innerHTML = '<option value="all">Alle Kategorien</option>';
            
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function filterData() {
            updateView();
        }

        function updateView() {
            const viewMode = document.getElementById('viewMode').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filteredReceipts = allReceipts;
            
            if (dateFilter && viewMode !== 'all') {
                const [year, month] = dateFilter.split('-').map(Number);
                
                filteredReceipts = filteredReceipts.filter(receipt => {
                    const receiptDate = new Date(receipt.date);
                    
                    switch (viewMode) {
                        case 'month':
                            return receiptDate.getFullYear() === year && 
                                   receiptDate.getMonth() + 1 === month;
                        case 'year':
                            return receiptDate.getFullYear() === year;
                        case 'week':
                            const startOfMonth = new Date(year, month - 1, 1);
                            const endOfMonth = new Date(year, month, 0);
                            return receiptDate >= startOfMonth && receiptDate <= endOfMonth;
                        default:
                            return true;
                    }
                });
            }
            
            if (categoryFilter !== 'all') {
                filteredReceipts = filteredReceipts.map(receipt => ({
                    ...receipt,
                    items: receipt.items.filter(item => 
                        (item.category || categorizeProduct(item.name)) === categoryFilter
                    ),
                    total: receipt.items
                        .filter(item => (item.category || categorizeProduct(item.name)) === categoryFilter)
                        .reduce((sum, item) => sum + item.price, 0)
                })).filter(receipt => receipt.items.length > 0);
            }
            
            updateStats(filteredReceipts);
            updateCharts(filteredReceipts);
            updateTables(filteredReceipts);
        }

        function updateStats(receipts) {
            const totalSpent = receipts.reduce((sum, r) => sum + r.total, 0);
            const totalReceipts = receipts.length;
            const avgPerReceipt = totalReceipts > 0 ? totalSpent / totalReceipts : 0;
            
            const uniqueProducts = new Set();
            receipts.forEach(r => r.items.forEach(i => uniqueProducts.add(i.name)));
            
            document.getElementById('totalSpent').textContent = totalSpent.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalReceipts').textContent = totalReceipts;
            document.getElementById('avgPerReceipt').textContent = avgPerReceipt.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalProducts').textContent = uniqueProducts.size;
        }

        function updateCharts(receipts) {
            updateCategoryChart(receipts);
            updateTimelineChart(receipts);
            updateTopProductsChart(receipts);
            updatePriceChart(receipts);
        }

        function updateCategoryChart(receipts) {
            const categoryData = {};
            
            receipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    const category = item.category || categorizeProduct(item.name);
                    categoryData[category] = (categoryData[category] || 0) + item.price;
                });
            });
            
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (charts.category) {
                charts.category.destroy();
            }
            
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#43e97b', '#fa709a', '#fee140',
                            '#30cfd0', '#a8edea', '#fd79a8', '#fdcb6e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(2)} ‚Ç¨ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTimelineChart(receipts) {
            const timelineData = {};
            
            receipts.forEach(receipt => {
                const date = new Date(receipt.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                timelineData[monthKey] = (timelineData[monthKey] || 0) + receipt.total;
            });
            
            const sortedMonths = Object.keys(timelineData).sort();
            
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timeline) {
                charts.timeline.destroy();
            }
            
            charts.timeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const [year, m] = month.split('-');
                        return `${m}/${year}`;
                    }),
                    datasets: [{
                        label: 'Ausgaben',
                        data: sortedMonths.map(month => timelineData[month]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Ausgaben: ${context.parsed.y.toFixed(2)} ‚Ç¨`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTopProductsChart(receipts) {
            const productCount = {};
            
            receipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    productCount[item.name] = (productCount[item.name] || 0) + 1;
                });
            });
            
            const sortedProducts = Object.entries(productCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }
            
            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(p => p[0]),
                    datasets: [{
                        label: 'Anzahl K√§ufe',
                        data: sortedProducts.map(p => p[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function updatePriceChart(receipts) {
            const popularProducts = ['BANANE', 'APFEL', 'MILCH', 'JOGHURT', 'BROT', 'BUTTER'];
            const filterContainer = document.getElementById('productFilter');
            filterContainer.innerHTML = '';
            
            const existingProducts = popularProducts.filter(product => 
                receipts.some(r => r.items.some(i => i.name.includes(product)))
            );
            
            existingProducts.forEach(product => {
                const chip = document.createElement('div');
                chip.className = 'category-chip';
                chip.textContent = product;
                chip.onclick = () => {
                    chip.classList.toggle('active');
                    updatePriceChartData(receipts);
                };
                filterContainer.appendChild(chip);
            });
            
            if (filterContainer.firstChild) {
                filterContainer.firstChild.classList.add('active');
            }
            
            updatePriceChartData(receipts);
        }

        function updatePriceChartData(receipts) {
            const activeProducts = Array.from(document.querySelectorAll('#productFilter .category-chip.active'))
                .map(chip => chip.textContent);
            
            if (activeProducts.length === 0) return;
            
            const datasets = activeProducts.map((productKeyword, index) => {
                const priceData = {};
                
                receipts.forEach(receipt => {
                    receipt.items.forEach(item => {
                        if (item.name.includes(productKeyword)) {
                            const date = new Date(receipt.date);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            const unitPrice = item.quantity > 0 ? item.price / item.quantity : item.price;
                            
                            if (!priceData[monthKey] || unitPrice < priceData[monthKey]) {
                                priceData[monthKey] = unitPrice;
                            }
                        }
                    });
                });
                
                const sortedMonths = Object.keys(priceData).sort();
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#43e97b'];
                
                return {
                    label: productKeyword,
                    data: sortedMonths.map(month => ({
                        x: month,
                        y: priceData[month]
                    })),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4
                };
            }).filter(dataset => dataset.data.length > 0);
            
            if (datasets.length === 0) return;
            
            const allMonths = [...new Set(datasets.flatMap(d => d.data.map(p => p.x)))].sort();
            
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (charts.price) {
                charts.price.destroy();
            }
            
            charts.price = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allMonths.map(month => {
                        const [year, m] = month.split('-');
                        return `${m}/${year}`;
                    }),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} ‚Ç¨/Einheit`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTables(receipts) {
            updateProductsTable(receipts);
            updateReceiptsTable(receipts);
        }

        function updateProductsTable(receipts) {
            const productStats = {};
            
            receipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = {
                            name: item.name,
                            category: item.category || categorizeProduct(item.name),
                            count: 0,
                            total: 0,
                            prices: []
                        };
                    }
                    
                    productStats[item.name].count++;
                    productStats[item.name].total += item.price;
                    productStats[item.name].prices.push(item.price);
                });
            });
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            Object.values(productStats)
                .sort((a, b) => b.total - a.total)
                .forEach(product => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = product.name;
                    row.insertCell(1).textContent = product.category;
                    row.insertCell(2).textContent = product.count;
                    row.insertCell(3).textContent = (product.total / product.count).toFixed(2) + ' ‚Ç¨';
                    row.insertCell(4).textContent = Math.min(...product.prices).toFixed(2) + ' ‚Ç¨';
                    row.insertCell(5).textContent = Math.max(...product.prices).toFixed(2) + ' ‚Ç¨';
                    row.insertCell(6).textContent = product.total.toFixed(2) + ' ‚Ç¨';
                });
        }

        function updateReceiptsTable(receipts) {
            const tbody = document.getElementById('receiptsTableBody');
            tbody.innerHTML = '';
            
            receipts
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(receipt => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = new Date(receipt.date).toLocaleDateString('de-DE');
                    row.insertCell(1).textContent = receipt.store;
                    row.insertCell(2).textContent = receipt.items.length;
                    row.insertCell(3).textContent = receipt.total.toFixed(2) + ' ‚Ç¨';
                });
        }

        function showCharts() {
            document.getElementById('chartsView').style.display = 'block';
            document.getElementById('tablesView').style.display = 'none';
            document.querySelectorAll('.toggle-button')[0].classList.add('active');
            document.querySelectorAll('.toggle-button')[1].classList.remove('active');
        }

        function showTables() {
            document.getElementById('chartsView').style.display = 'none';
            document.getElementById('tablesView').style.display = 'block';
            document.querySelectorAll('.toggle-button')[0].classList.remove('active');
            document.querySelectorAll('.toggle-button')[1].classList.add('active');
        }

        window.addEventListener('resize', () => {
            Object.values(charts).forEach(chart => {
                if (chart) chart.resize();
            });
        });
    </script>
</body>
</html>
